<div class="stamp-detail-container">
    <!-- Hidden file input for image uploads -->
    <input type="file" 
           id="imageUpload" 
           accept="image/*" 
           style="display: none;" 
           onchange="handleImageUpload('{{.Stamp.ID}}', this)">
    
    <!-- Back button -->
    <div class="mb-3">
        <button class="btn btn-outline-secondary" 
                hx-get="/views/stamps/gallery" 
                hx-target="#stamp-view-content"
                hx-swap="innerHTML">
            <i class="bi bi-arrow-left"></i> Back to Collection
        </button>
    </div>

    <div class="row">
        <!-- Image Column -->
        <div class="col-lg-5 col-md-6 mb-4">
            {{template "stamp-image-section" .}}
        </div>

        <!-- Details Column -->
        <div class="col-lg-7 col-md-6">
            {{template "stamp-details-section" .}}
        </div>
    </div>

    <!-- Your Copies Section (Full Width) -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="your-copies-section">
                <div class="section-header">
                    <h4 class="section-title">
                        <i class="bi bi-collection"></i> Your Copies
                        <span class="total-count">({{len .Stamp.Instances}} {{if eq (len .Stamp.Instances) 1}}group{{else}}groups{{end}})</span>
                    </h4>
                    <button class="btn btn-sm btn-primary add-copy-btn" onclick="addNewCopy('{{.Stamp.ID}}')">
                        <i class="bi bi-plus-circle"></i> Add Copies
                    </button>
                </div>

                {{if .Stamp.Instances}}
                <div class="copies-table-container">
                    <table class="copies-table">
                        <thead>
                            <tr>
                                <th>Condition</th>
                                <th>Storage Box</th>
                                <th>Quantity</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody id="copies-table-body">
                            {{range .Stamp.Instances}}
                            <tr data-instance-id="{{.ID}}">
                                <td>
                                    <select class="form-select instance-field" 
                                            data-field="condition" 
                                            data-instance-id="{{.ID}}"
                                            onchange="saveInstanceField(this)">
                                        <option value="">No condition specified</option>
                                        <option value="Mint" {{if and .Condition (eq (deref .Condition) "Mint")}}selected{{end}}>Mint</option>
                                        <option value="Used" {{if and .Condition (eq (deref .Condition) "Used")}}selected{{end}}>Used</option>
                                        <option value="Damaged" {{if and .Condition (eq (deref .Condition) "Damaged")}}selected{{end}}>Damaged</option>
                                        <option value="Fine" {{if and .Condition (eq (deref .Condition) "Fine")}}selected{{end}}>Fine</option>
                                        <option value="Very Fine" {{if and .Condition (eq (deref .Condition) "Very Fine")}}selected{{end}}>Very Fine</option>
                                        <option value="Excellent" {{if and .Condition (eq (deref .Condition) "Excellent")}}selected{{end}}>Excellent</option>
                                    </select>
                                </td>
                                <td>
                                    <input class="info-value-input" 
                                           list="box-options-{{.ID}}" 
                                           id="box-input-{{.ID}}" 
                                           name="box_name"
                                           value="{{if .BoxName}}{{deref .BoxName}}{{end}}" 
                                           placeholder="Type or select a box"
                                           data-instance-id="{{.ID}}" 
                                           onchange="handleBoxChange(this)"
                                           onkeydown="handleBoxInput(event, this)" 
                                          autocomplete="off">

                                    <datalist id="box-options-{{.ID}}">
                                        {{range $.AllBoxes}}
                                        <option value="{{.Name}}" data-id="{{.ID}}"></option>
                                        {{end}}
                                    </datalist>
                                </td>
                                <td>
                                    <div class="quantity-controls">
                                        <button class="quantity-btn" onclick="adjustInstanceQuantity('{{.ID}}', -1)">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        <input type="number" 
                                               class="quantity-input instance-field" 
                                               value="{{.Quantity}}"
                                               min="0"
                                               data-field="quantity" 
                                               data-instance-id="{{.ID}}"
                                               onchange="saveInstanceField(this)"
                                               onblur="saveInstanceField(this)">
                                        <button class="quantity-btn" onclick="adjustInstanceQuantity('{{.ID}}', 1)">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger delete-instance-btn" 
                                            onclick="deleteInstance('{{.ID}}')"
                                            title="Delete this group">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
                {{else}}
                <div class="no-copies-message">
                    <div class="empty-state">
                        <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                        <h5>No copies in your collection</h5>
                        <p class="text-muted">Add some copies of this stamp to track your inventory.</p>
                        <button class="btn btn-primary" onclick="addNewCopy('{{.Stamp.ID}}')">
                            <i class="bi bi-plus-circle"></i> Add Your First Copy
                        </button>
                    </div>
                </div>
                {{end}}
            </div>
        </div>
    </div>

    <!-- Notes Section (Full Width) -->
    <div class="row mt-4">
        <div class="col-12">
            {{template "stamp-notes-section" .}}
        </div>
    </div>

    <!-- Metadata -->
    <div class="stamp-metadata mt-4 pt-3 border-top">
        <small class="text-muted">
            Added {{.Stamp.DateAdded.Format "Jan 2, 2006"}}
            {{$isModified := ne .Stamp.DateModified.Unix .Stamp.DateAdded.Unix}}
            {{if $isModified}}
            â€¢ Modified {{.Stamp.DateModified.Format "Jan 2, 2006"}}
            {{end}}
        </small>
    </div>

    <!-- Action Buttons -->
    <div class="stamp-actions mt-4">
        <button class="btn btn-delete" onclick="deleteStamp('{{.Stamp.ID}}')">
            <i class="bi bi-trash"></i> Delete Stamp
        </button>
    </div>
</div>

<script src="/static/js/stamp-detail.js"></script>